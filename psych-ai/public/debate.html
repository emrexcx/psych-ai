<script>
    // ⚠️⚠️⚠️ 记得检查 Bot ID 和 图片路径 ⚠️⚠️⚠️
    const agents = [
        { id: 'freud', name: '弗洛伊德', botId: '7576937790106402857', avatar: 'images/freud.png' },
        { id: 'jung', name: '荣格', botId: '7576939753841508378', avatar: 'images/jung.png' },
        { id: 'adler', name: '阿德勒', botId: '7576940585882550326', avatar: 'images/adler.png' },
        { id: 'contemporary', name: '当代动力', botId: '7576941130223255578', avatar: 'images/contemp.png' },
        { id: 'narrative', name: '叙事治疗', botId: '7576941141384544262', avatar: 'images/narrative.png' }
    ];

    let agentBuffers = {};
    const chatArena = document.getElementById('chat-arena');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const placeholder = document.getElementById('placeholder-container');
    const previewArea = document.getElementById('avatar-preview-area');
    const previewBtn = document.getElementById('preview-btn');

    function togglePreview() {
        if (previewArea.style.display === 'flex') {
            previewArea.style.display = 'none';
            previewBtn.innerHTML = '[ 扫描专家 ]';
        } else {
            if (previewArea.innerHTML.trim() === '') {
                agents.forEach(agent => {
                   const item = document.createElement('div');
                   item.style.display = 'flex'; item.style.flexDirection = 'column'; item.style.alignItems = 'center';
                   item.innerHTML = `<div class="avatar" style="background-image: url('${agent.avatar}'); border-color:var(--neon-cyan)"></div><div style="font-size:10px; color:#fff; margin-top:5px;">${agent.name}</div>`;
                   previewArea.appendChild(item);
                });
            }
            previewArea.style.display = 'flex';
            previewBtn.innerHTML = '[ 关闭扫描 ]';
        }
    }

    function handleKeyPress(e) { if (e.key === 'Enter') startBrawl(); }

    async function startBrawl() {
        const query = userInput.value.trim();
        if (!query) return;
        
        userInput.value = ''; sendBtn.disabled = true; 
        if(placeholder) placeholder.style.display = 'none';
        
        addMessage('user', 'OPERATOR', query); 

        const bubbleElements = {};
        agents.forEach(agent => {
            agentBuffers[agent.id] = ''; 
            bubbleElements[agent.id] = addMessage('agent', agent.name, '<span style="animation:blink 1s infinite">_</span>', agent.avatar);
        });

        const debatePrompt = `【辩论指令：简短、犀利、反驳他人。50字内。】用户：${query}`;

        const tasks = agents.map(agent => simulateCozeAPIStream(agent.id, debatePrompt, (chunk) => {
            agentBuffers[agent.id] += chunk;
            bubbleElements[agent.id].innerHTML = marked.parse(agentBuffers[agent.id]);
            scrollToBottom();
        }));

        await Promise.all(tasks);
        sendBtn.disabled = false; scrollToBottom();
    }

    function addMessage(type, name, content, avatarUrl) {
        const isUser = type === 'user';
        const avatar = isUser ? 'https://placehold.co/100/bd00ff/fff?text=OP' : avatarUrl;
        const html = `<div class="message-group ${type}"><div class="avatar" style="background-image: url('${avatar}')"></div><div class="message-content"><div class="agent-name">${name}</div><div class="bubble">${content}</div></div></div>`;
        chatArena.insertAdjacentHTML('beforeend', html); scrollToBottom();
        const bubbles = chatArena.querySelectorAll('.bubble');
        return bubbles[bubbles.length - 1];
    }

    function scrollToBottom() { chatArena.scrollTop = chatArena.scrollHeight; }

    // ✅ 前端强力清洗函数
    async function simulateCozeAPIStream(agentId, prompt, onChunk) {
        const agent = agents.find(a => a.id === agentId);
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: prompt, bot_id: agent.botId, conversation_id: "debate_" + Date.now() })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data:') && line.length > 5) {
                        try {
                            const rawJson = line.slice(5).trim();
                            if (rawJson === '[DONE]') continue;
                            const data = JSON.parse(rawJson);

                            // ✂️ 核心修改 1：只允许 DELTA (增量) 消息！
                            // Coze 会发两种消息：delta (一个字一个字) 和 completed (整句总结)。
                            // 我们只收 delta，坚决不要 completed，这样就不会重复了！
                            if (data.event !== 'conversation.message.delta') continue;

                            if (data.message && data.message.content) {
                                let content = data.message.content;
                                
                                // ✂️ 核心修改 2：过滤 JSON 日志
                                if (content.trim().startsWith('{') || content.includes('msg_type')) {
                                    continue;
                                }
                                
                                // ✂️ 核心修改 3：过滤追问建议
                                if (data.message.type === 'follow_up') continue;

                                // ✂️ 核心修改 4：去掉 [1]therapy 这种引用
                                content = content.replace(/\[\d+\]\s*therapy_.*?(\n|$)/gi, '');

                                onChunk(content);
                            }
                        } catch (e) {}
                    }
                }
            }
        } catch (err) {
            onChunk(" [网络波动] ");
        }
    }
</script>


